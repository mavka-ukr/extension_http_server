взяти визначення РМв1;

структура xxx_header {
  key: адреса<char>;
  value: адреса<char>;
}
синонім xxx_respond = (request: адреса, status: int, headers: адреса<xxx_header>, headers_size: int, data: адреса<char>, data_size: int) -> ніщо;

зовнішня дія start_http_server(port: int, handler: (request: адреса, path: адреса<char>, headers: адреса<xxx_header>, headers_size: int, body: адреса<char>, body_size: int, respond: xxx_respond, data: адреса) -> ніщо, data: адреса);

структура ДаніОбробникаЗапиту {
  Р: адреса<РМв1::Розширення>;
  обробник: адреса<РМв1::Обʼєкт>;
}

структура ДаніНативноїДіїВідповісти {
  request: адреса;
  respond: xxx_respond;
}

дія нативна_дія_відповісти(обʼєкт_нативної_дії: адреса<РМв1::Обʼєкт>, Р: адреса<РМв1::Розширення>, обʼєкт_я: адреса<РМв1::Обʼєкт>, кількість_аргументів: позитивне, аргументи: адреса<адреса<РМв1::Обʼєкт>>, іменовані_аргументи: адреса, дані: адреса): РМв1::Результат {
  ціль дані_нативної_дії_відповісти = дані як адреса<ДаніНативноїДіїВідповісти>;
  якщо кількість_аргументів > 2 {
    ціль аргумент_статусу = аргументи[0];
    ціль аргумент_заголовків = аргументи[1];
    ціль аргумент_тіла = аргументи[2];
    ціль статус = позитивне(РМв1::отримати_значення_числа(аргумент_статусу, Р));
    ціль заголовки: адреса<xxx_header> = пусто;
    ціль розмір_заголовків: позитивне = 0;
    ціль дані: адреса<п8> = пусто;
    ціль розмір_даних: позитивне = 0;
    дані_нативної_дії_відповісти.respond(дані_нативної_дії_відповісти.request, int(статус), заголовки, int(розмір_заголовків), дані як адреса<char>, int(розмір_даних));
    вернути РМв1::успіх(Р, пусто);
  }
  вернути РМв1::падіння(Р, РМв1::створити_текст_з_Ю8(Р, ю8"Недостатньо аргументів"));
}

дія відклик_перед_звільненням_нативної_дії_відповісти(обʼєкт_нативної_дії: адреса<РМв1::Обʼєкт>, Р: адреса<РМв1::Розширення>, дані: адреса) {
  ціль дані_нативної_дії_відповісти = дані як адреса<ДаніНативноїДіїВідповісти>;
//  РМв1::звільнити(Р, дані_нативної_дії_відповісти);
}

дія http_request_handler(request: адреса, path: адреса<char>, headers: адреса<xxx_header>, headers_size: int, body: адреса<char>, body_size: int, respond: xxx_respond, data: адреса) {
  ціль дані_обробника_запиту = data як адреса<ДаніОбробникаЗапиту>;
  ціль Р = дані_обробника_запиту.Р;
  ціль обробник = дані_обробника_запиту.обробник;
  ціль аргументи = РМв1::виділити<адреса<РМв1::Обʼєкт>>(Р, 4);
  аргументи[0] = пусто як адреса<РМв1::Обʼєкт>;
  аргументи[1] = пусто як адреса<РМв1::Обʼєкт>;
  аргументи[2] = пусто як адреса<РМв1::Обʼєкт>;
  ціль дані_нативної_дії_відповісти = РМв1::виділити<ДаніНативноїДіїВідповісти>(Р);
  дані_нативної_дії_відповісти.request = request;
  дані_нативної_дії_відповісти.respond = respond;
  аргументи[3] = РМв1::створити_нативну_дію(Р, РМв1::назва_з_Ю8(Р, ю8"відповісти"), нативна_дія_відповісти, дані_нативної_дії_відповісти, відклик_перед_звільненням_нативної_дії_відповісти);
  ціль результат_обробника = РМв1::обʼєкт_виконати(обробник, Р, пусто, 4, аргументи);
//  РМв1::звільнити(Р, аргументи);
  якщо результат_обробника.падіння == пусто {
  } інакше {
    РМв1::обробити_падіння(Р, результат_обробника.падіння, результат_обробника.значення);
  }
}

дія нативна_http_server(обʼєкт_нативної_дії: адреса<РМв1::Обʼєкт>, Р: адреса<РМв1::Розширення>, обʼєкт_я: адреса<РМв1::Обʼєкт>, кількість_аргументів: позитивне, аргументи: адреса<адреса<РМв1::Обʼєкт>>, іменовані_аргументи: адреса, дані: адреса): РМв1::Результат {
  якщо кількість_аргументів > 1 {
    ціль аргумент_порта = аргументи[0];
    ціль аргумент_обробника = аргументи[1];
    ціль порт = позитивне(РМв1::отримати_значення_числа(аргумент_порта, Р));
    ціль дані_обробника_запиту = РМв1::виділити<ДаніОбробникаЗапиту>(Р);
    дані_обробника_запиту.Р = Р;
    дані_обробника_запиту.обробник = аргументи[1];
    РМв1::зберегти_обʼєкт(Р, аргументи[1]);
    start_http_server(int(порт), http_request_handler, дані_обробника_запиту);
    РМв1::видалити_збережений_обʼєкт(Р);
    вернути РМв1::успіх(Р, пусто);
  }
  вернути РМв1::падіння(Р, РМв1::створити_текст_з_Ю8(Р, ю8"Недостатньо аргументів"));
}

зовнішня дія завантажити_РМв1(Р: адреса<РМв1::Розширення>): РМв1::Результат {
  ціль обʼєкт_нативної_дії_http_server = РМв1::створити_нативну_дію(Р, РМв1::назва_з_Ю8(Р, ю8"http_server"), нативна_http_server, пусто, пусто);
  вернути РМв1::успіх(Р, обʼєкт_нативної_дії_http_server);
}